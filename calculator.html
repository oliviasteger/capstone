<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&display=swap" rel="stylesheet">
  <script src="nerdamer.core.js"></script>
  <script src="Algebra.js"></script>
  <script src="Calculus.js"></script>
  <script src="Solve.js"></script>
  <script src="Extra.js"></script>
  <title>Square Integration</title>
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: '#f8f8f8';
      color: '#2b2b28';
      font-size: 16px;
      padding: 0px;
      margin: 0px;
    }

    table {
      margin: 0px;
      padding: 0px;
    }

    h2 {
      font-family: 'Oswald', sans-serif;
    }

    tr {
      padding: 0px;
      margin: 0px;
    }

    td {
      padding: 0px;
      margin: 0px;
    }

    #input-container {
      padding: 10px;
      height: 100%;
    }

    input {
      font-family: 'Oswald', sans-serif;
      height: 3vh;
      width: 15vw;
      font-size: 16px;
    }

    button {
      font-family: 'Oswald', sans-serif;
      height: 5vh;
      width: 15vw;
      font-size: 16px;
    }

    #code {
      text-align: left;
      font-size: 10px;
      margin: 20px;
    }
  </style>
</head>

<body>
  <center>
    <div id="input-container">
      <h2>Equations to STL Files</h2>
      <p>To use the calculator, enter the two equations that form the volume <br>and change the slice width to your
        desired
        width. (Lower slice width, higher model quality.)</p>
      <button id="help">Help</button> <button id="example">See an example</button><br><br>
      <p>Equation One: <input type="text" id="eq1"></input></p>
      <p>Equation Two: <input type="text" id="eq2"></input></p>
      <p>Slice Width: <input type="text" id="width"></input></p><br>
      <button id="calculate">Calculate</button>
      <button id="copy" onclick="copyScript()">Copy Script</button><br>
    </div>

    <p id="code"></p><br><br>

    <script>
      // Set default equation values
      document.getElementById('eq1').value = "2*x^2 - 6*x + 4";
      document.getElementById('eq2').value = "4*cos(pi*x/4)";
      document.getElementById('width').value = "0.01";

      let update = false;

      // Replaced trig functions and pi in equations
      function edit(string) {
        string = string.replace(/pi/g, 'Math.PI');
        string = string.replace(/sin/g, 'Math.sin');
        string = string.replace(/cos/g, 'Math.cos');
        string = string.replace(/tan/g, 'Math.tan');
        string = string.replace(/sqrt/g, 'Math.sqrt');

        return string;
      }

      $("#help").click(function () {
        alert(
          "Please enter two functions that have exactly two points of intersection. Then select the width that you would like the slices to be. \n \nTo use the script, open a new TinkerCad project. The open the dropdown that says 'Basic Shapes' and scroll to 'Your Shape Generators'. Click 'Your Shape Generators' and select 'Create Shape Generator.' Click 'New Shape Generator.' Select 'Empty' from the dropdown menu. In the tab on the left side of the screen, paste the code that was generated."
        )
      })

      $("#calculate").click(function () {
        // Set variables for both equations
        var eq1 = document.getElementById('eq1').value;
        var eq2 = document.getElementById('eq2').value;
        var width = eval(document.getElementById('width').value);

        // Calculate base area of solid
        var x = nerdamer(eq1).subtract(eq2);
        x = nerdamer('defint(' + x.toString() + ', 2, 0, x)');
        //document.getElementById('area').innerHTML = 'Base Area: ' + x.toString();

        let intersection1 = 0;
        let intersection2 = 0;

        // Get solutions for equations
        nerdamer.set('SOLUTIONS_AS_OBJECT', false);
        let z = eq1 + '=' + eq2;
        var sol = nerdamer.solveEquations(z, 'x').toString();
        var xpoints = sol.split(',');
        var ypoints = [];
        var points = [];

        var bottom = [];
        var top = [];
        var labels = [];

        let xMin;
        let xMax;

        let yMin;
        let yMax;

        for (let i = 0; i < xpoints.length; i++) {
          xpoints[i] = edit(xpoints[i]);
          xpoints[i] = eval(xpoints[i]);
        }

        xpoints.sort();

        // See if the lines intersect at the solutions
        for (let i = 0; i < xpoints.length; i++) {
          let eq1edit = 'y = ' + eq1.replace(/x/g, '(' + xpoints[i] + ')');
          let eq2edit = 'y = ' + eq2.replace(/x/g, '(' + xpoints[i] + ')');

          let eq1solution = nerdamer.solve(eq1edit, 'y').toString();
          eq1solution = edit(eq1solution);
          eq1solution = eval(eq1solution);

          let eq2solution = nerdamer('solve(' + eq2edit + ', y)').toString();
          eq2solution = edit(eq2solution);
          eq2solution = eval(eq2solution);

          // If the two y-values are the same, it becomes a point
          if (eq1solution[0] === eq2solution[0]) {
            ypoints[i] = eq1solution[0];
          } else {
            ypoints[i] = null;
          }
        }

        let tempx = [];
        let tempy = [];

        // Create separate x and y arrays
        for (let i = 0; i < ypoints.length; i++) {
          if (ypoints[i] !== null) {
            tempx.push(xpoints[i]);
            tempy.push(ypoints[i]);
          }
        }

        ypoints = tempy;
        xpoints = tempx;

        // Create array of (x, y) points
        for (let i = 0; i < xpoints.length; i++) {
          if (ypoints[i] !== null) {
            points[i] = [xpoints[i], ypoints[i]];
          }
        }

        if (points.length == 0) {
          alert("These equations have more than two solutions.");
        }

        xMin = points[0][0];
        xMax = points[1][0];

        for (let i = points[0][0]; i <= points[1][0] + width; i = i + width) {
          // Create labels for the graph
          labels.push(Math.round(1000 * i) / 1000);

          // Create both equations again
          let eq1edit = 'y = ' + eq1.replace(/x/g, '(' + i + ')');
          let eq2edit = 'y = ' + eq2.replace(/x/g, '(' + i + ')');

          // Solve equation 1 for its y value at the specified x value
          let eq1solution = nerdamer('solve(' + eq1edit + ', y)').toString();
          eq1solution = eq1solution.split(',')[0];
          eq1solution = edit(eq1solution);
          eq1solution = eval(eq1solution.substring(1, eq1solution.length - 1));

          // Solve equation 2 for its y value at the specified x value
          let eq2solution = nerdamer('solve(' + eq2edit + ', y)').toString();
          eq2solution = eq2solution.split(',')[0];
          eq2solution = edit(eq2solution);
          eq2solution = eval(eq2solution.substring(1, eq2solution.length - 1));

          // Look back to test
          if (i === points[0][0]) {
            if (eq1solution > eq2solution) {
              yMax = eq1solution;
              yMin = eq2solution;
            } else {
              yMax = eq2solution;
              yMin = eq1solution;
            }
          }

          // Reset minimum and maximum values
          if (eq1solution > eq2solution) {
            let temp = eq1solution;
            eq1solution = eq2solution;
            eq2solution = temp;
          }

          if (eq1solution < yMin) {
            yMin = eq1solution;
          }

          if (eq1solution > yMax) {
            yMax = eq1solution;
          }

          if (eq2solution < yMin) {
            yMin = eq2solution;
          }

          if (eq2solution > yMax) {
            yMax = eq2solution;
          }

          bottom.push(eq1solution);
          top.push(eq2solution);
        }

        let bottomMeshes = [];
        let topMeshes = [];
        let leftMeshes = [];
        let rightMeshes = [];
        let frontMeshes = [];
        let backMeshes = [];

        // Point format is (X, Y, Z)

        for (let i = 0; i < bottom.length; i++) {
          let bottomY = 0;
          let topY = 0;

          if (bottom[i] > top[i]) {
            bottomY = top[i];
            topY = bottom[i];
          } else {
            bottomY = bottom[i];
            topY = top[i];
          }

          let verticeOne = [(10 * i * width), (10 * bottomY), 0];
          let verticeTwo = [(((10 * i * width) + width)), (10 * bottomY), 0];
          let verticeThree = [(((10 * i * width) + width)), (10 * topY), 0];
          let verticeFour = [(10 * i * width), (10 * topY), 0];
          let verticeFive = [(10 * i * width), (10 * bottomY), (10 * Math.abs(bottomY - topY))];
          let verticeSix = [(((10 * i * width) + width)), (10 * bottomY), (10 * Math.abs(bottomY - topY))];
          let verticeSeven = [(((10 * i * width) + width)), (10 * topY), (10 * Math.abs(bottomY - topY))];
          let verticeEight = [(10 * i * width), (10 * topY), (10 * Math.abs(bottomY - topY))];

          let bottomMesh = "mesh" + i + ".quad([" + verticeOne + "], [" + verticeTwo + "], [" + verticeThree +
            "], [" + verticeFour + "]);";
          let topMesh = "mesh" + i + ".quad([" + verticeFive + "], [" + verticeSix + "], [" + verticeSeven +
            "], [" + verticeEight + "]);";
          let leftMesh = "mesh" + i + ".quad([" + verticeOne + "], [" + verticeFive + "], [" + verticeEight +
            "], [" + verticeFour + "]);";
          let rightMesh = "mesh" + i + ".quad([" + verticeTwo + "], [" + verticeSix + "], [" + verticeSeven +
            "], [" + verticeThree + "]);";
          let frontMesh = "mesh" + i + ".quad([" + verticeOne + "], [" + verticeTwo + "], [" + verticeSix +
            "], [" + verticeFive + "]);";
          let backMesh = "mesh" + i + ".quad([" + verticeThree + "], [" + verticeSeven + "], [" + verticeEight +
            "], [" + verticeFour + "]);";

          console.log(verticeOne[0], verticeTwo[0]);

          bottomMeshes.push(bottomMesh);
          topMeshes.push(topMesh);
          leftMeshes.push(leftMesh);
          rightMeshes.push(rightMesh);
          frontMeshes.push(frontMesh);
          backMeshes.push(backMesh);

        }

        let script =
          "var Conversions = Core.Conversions; <br>var Debug = Core.Debug; <br>var Path2D = Core.Path2D; <br>var Point2D = Core.Point2D; <br>var Point3D = Core.Point3D; <br>var Matrix2D = Core.Matrix2D; <br>var Matrix3D = Core.Matrix3D; <br>var Mesh3D = Core.Mesh3D; <br>var Plugin = Core.Plugin; <br>var Tess = Core.Tess; <br>var Sketch2D = Core.Sketch2D; <br>var Solid = Core.Solid; <br>var Vector2D = Core.Vector2D; <br>var Vector3D = Core.Vector3D; <br>function process(params) { ";

        for (let i = 0; i < bottom.length; i++) {
          script += "var mesh" + i + " = new Mesh3D(); <br>" + bottomMeshes[i] + "<br>" + topMeshes[i] + "<br>" +
            leftMeshes[i] + "<br>" + rightMeshes[i] + "<br>" + frontMeshes[i] + "<br>" + backMeshes[i] + "<br>";

          if (i != 0) {
            script += "mesh0.combine(mesh" + i + "); <br>";
          }
        }

        script += "return Solid.make(mesh0); }";

        document.getElementById('code').innerHTML = script;
      });

      function copyScript() {
        /* Get the text field */
        var copyText = document.getElementById("code");

        /* Select the text field */
        copyText.select();

        /* Copy the text inside the text field */
        document.execCommand("copy");

        alert("Copied the text: " + copyText.value);
      }

      $("#example").click(function () {
        window.location.href = "https://www.tinkercad.com/embed/ayvLigs6vC3?editbtn=1";
      })
    </script>
</body>

</html>